name: CI

on:
  push:
  workflow_dispatch:
    inputs:
      version:
        description: 'Talos version to build'
        required: true
        type: string

jobs:
  build:
    name: Build Talos ${{ matrix.arch }}
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        include:
          - arch: amd64
          - arch: arm64
    env:
      TALOS_VERSION: ${{ github.event.inputs.version || 'v1.12.0' }} # renovate: datasource=github-tags depName=siderolabs/talos
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y zstd qemu-utils tar xz-utils curl jq

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Download and verify upstream bundle
        run: |
          BASE_URL="https://github.com/siderolabs/talos/releases/download/${TALOS_VERSION}"
          WORK_DIR="build-${{ matrix.arch }}"
          mkdir -p "${WORK_DIR}"
          
          RAW_FILE="${WORK_DIR}/metal-${{ matrix.arch }}.raw.zst"
          BUNDLE_FILE="${RAW_FILE}.bundle"
          
          echo "Downloading raw image and bundle..."
          curl -L -f "${BASE_URL}/metal-${{ matrix.arch }}.raw.zst" -o "${RAW_FILE}"
          curl -L -f "${BASE_URL}/metal-${{ matrix.arch }}.raw.zst.bundle" -o "${BUNDLE_FILE}"
          
          echo "Verifying bundle signature..."
          cosign verify-blob \
            --bundle "${BUNDLE_FILE}" \
            --certificate-identity-regexp '^https://github.com/siderolabs/talos' \
            --certificate-oidc-issuer 'https://token.actions.githubusercontent.com' \
            "${RAW_FILE}"
          echo "✓ Bundle signature verified"

      - name: Build split-format image
        run: |
          ./scripts/build-image.sh "${TALOS_VERSION}" "${{ matrix.arch }}"

      - name: Verify artifacts
        run: |
          META_FILE="talos-${{ matrix.arch }}-incus.tar.xz"
          DISK_FILE="talos-${{ matrix.arch }}.qcow2"
          for file in "${META_FILE}" "${DISK_FILE}"; do
            if [ ! -f "$file" ]; then
              echo "Error: $file not found"
              exit 1
            fi
          done
          echo "✓ Artifacts verified:"
          ls -lh "${META_FILE}" "${DISK_FILE}"

      - name: Calculate SHA256 hashes and sizes
        id: hashes
        run: |
          META_FILE="talos-${{ matrix.arch }}-incus.tar.xz"
          DISK_FILE="talos-${{ matrix.arch }}.qcow2"
          
          META_HASH=$(sha256sum "${META_FILE}" | cut -d' ' -f1)
          DISK_HASH=$(sha256sum "${DISK_FILE}" | cut -d' ' -f1)
          META_SIZE=$(stat -c%s "${META_FILE}")
          DISK_SIZE=$(stat -c%s "${DISK_FILE}")
          
          cat "${META_FILE}" "${DISK_FILE}" | sha256sum | cut -d' ' -f1 > /tmp/combined_hash
          COMBINED_HASH=$(cat /tmp/combined_hash)
          
          CREATION_DATE=$(date +%s)
          
          echo "meta_hash=${META_HASH}" >> $GITHUB_OUTPUT
          echo "disk_hash=${DISK_HASH}" >> $GITHUB_OUTPUT
          echo "combined_hash=${COMBINED_HASH}" >> $GITHUB_OUTPUT
          echo "meta_size=${META_SIZE}" >> $GITHUB_OUTPUT
          echo "disk_size=${DISK_SIZE}" >> $GITHUB_OUTPUT
          echo "creation_date=${CREATION_DATE}" >> $GITHUB_OUTPUT
          echo "meta_file=${META_FILE}" >> $GITHUB_OUTPUT
          echo "disk_file=${DISK_FILE}" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: talos-${{ matrix.arch }}
          path: |
            talos-${{ matrix.arch }}-incus.tar.xz
            talos-${{ matrix.arch }}.qcow2
          retention-days: 1

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      id-token: write
    env:
      TALOS_VERSION: ${{ github.event.inputs.version || 'v1.12.0' }} # renovate: datasource=github-tags depName=siderolabs/talos
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Check if release exists
        id: check_release
        run: |
          if gh release view "${TALOS_VERSION}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release ${TALOS_VERSION} already exists, skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release ${TALOS_VERSION} does not exist, will create"
          fi

      - name: Download artifacts
        if: steps.check_release.outputs.exists == 'false'
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.8
        with:
          pattern: talos-*
          merge-multiple: true

      - name: Discover architectures
        if: steps.check_release.outputs.exists == 'false'
        id: arches
        run: |
          ARCHES=()
          for file in talos-*-incus.tar.xz; do
            if [ -f "$file" ]; then
              ARCH=$(echo "$file" | sed "s/talos-\(.*\)-incus.tar.xz/\1/")
              ARCHES+=("${ARCH}")
            fi
          done
          # Remove duplicates and sort
          UNIQUE_ARCHES=($(printf '%s\n' "${ARCHES[@]}" | sort -u))
          echo "arches=$(IFS=,; echo "${UNIQUE_ARCHES[*]}")" >> $GITHUB_OUTPUT
          echo "Found architectures: ${UNIQUE_ARCHES[*]}"

      - name: Sign artifacts
        if: steps.check_release.outputs.exists == 'false'
        run: |
          ./scripts/sign-artifacts.sh "${{ steps.arches.outputs.arches }}"

      - name: Look up KV namespace ID by name
        if: steps.check_release.outputs.exists == 'false'
        id: kv_namespace
        run: |
          NAMESPACE_NAME="windsorcli-dev-images"
          NAMESPACE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/storage/kv/namespaces" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" | \
            python3 -c "import sys, json; data=json.load(sys.stdin); ns=[n for n in data.get('result', []) if n.get('title') == '$NAMESPACE_NAME']; print(ns[0]['id'] if ns else '')" || echo "")
          
          if [ -z "$NAMESPACE_ID" ]; then
            echo "Error: KV namespace '$NAMESPACE_NAME' not found"
            exit 1
          fi
          
          echo "namespace_id=$NAMESPACE_ID" >> $GITHUB_OUTPUT

      - name: Upload metadata to Cloudflare KV
        if: steps.check_release.outputs.exists == 'false'
        run: |
          ./scripts/upload-kv-metadata.sh \
            "${{ steps.kv_namespace.outputs.namespace_id }}" \
            "${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            "${TALOS_VERSION}" \
            "${{ steps.arches.outputs.arches }}"

      - name: Create GitHub Release
        if: steps.check_release.outputs.exists == 'false'
        run: |
          ./scripts/create-release.sh \
            "${TALOS_VERSION}" \
            "${{ steps.arches.outputs.arches }}"
